const nodemailer = require('nodemailer');

class EmailService {
  constructor() {
    this.transporter = null;
    this.initializeTransporter();
  }

  initializeTransporter() {
    try {
      console.log('üîß Initializing email transporter...');
      console.log('üìß Email config check:', {
        EMAIL_SERVICE: process.env.EMAIL_SERVICE,
        EMAIL_USER: process.env.EMAIL_USER ? 'SET' : 'NOT SET',
        EMAIL_PASS: process.env.EMAIL_PASS ? 'SET' : 'NOT SET',
        EMAIL_FROM: process.env.EMAIL_FROM
      });

      // Check if required email configuration exists
      if (!process.env.EMAIL_USER || !process.env.EMAIL_PASS) {
        console.error('‚ùå Email configuration missing: EMAIL_USER and EMAIL_PASS are required');
        console.error('Current env vars:', {
          EMAIL_USER: process.env.EMAIL_USER,
          EMAIL_PASS: process.env.EMAIL_PASS ? '***' : 'NOT SET'
        });
        return;
      }

      // Determine email service configuration
      let emailConfig = {};

      // If EMAIL_SERVICE is set to gmail, use Gmail configuration
      if (process.env.EMAIL_SERVICE === 'gmail') {
        console.log('üìß Using Gmail service configuration');
        emailConfig = {
          service: 'gmail',
          auth: {
            user: process.env.EMAIL_USER,
            pass: process.env.EMAIL_PASS
          }
        };
      } else {
        console.log('üìß Using custom SMTP configuration');
        // Use custom SMTP configuration
        emailConfig = {
          host: process.env.EMAIL_HOST || 'smtp.gmail.com',
          port: process.env.EMAIL_PORT || 587,
          secure: false,
          auth: {
            user: process.env.EMAIL_USER,
            pass: process.env.EMAIL_PASS
          }
        };
      }

      console.log('üìß Creating transporter with config:', {
        service: emailConfig.service || 'custom smtp',
        host: emailConfig.host,
        port: emailConfig.port,
        user: emailConfig.auth.user
      });

      // Create transporter using the correct method
      this.transporter = nodemailer.createTransport(emailConfig);

      console.log('‚úÖ Email transporter initialized successfully');
    } catch (error) {
      console.error('‚ùå Error initializing email transporter:', error);
      this.transporter = null;
    }
  }

  async sendEmail(emailData) {
    try {
      if (!this.transporter) {
        console.error('‚ùå Transporter is null - checking initialization...');
        this.initializeTransporter(); // Try to initialize again
        
        if (!this.transporter) {
          throw new Error('Email transporter not initialized - check your EMAIL_USER and EMAIL_PASS configuration');
        }
      }

      const mailOptions = {
        from: process.env.EMAIL_FROM || process.env.EMAIL_USER,
        to: emailData.to,
        subject: emailData.subject,
        text: emailData.body,
        html: emailData.body // You can also send HTML emails
      };

      console.log('üìß Sending email with options:', {
        from: mailOptions.from,
        to: mailOptions.to,
        subject: mailOptions.subject
      });

      const result = await this.transporter.sendMail(mailOptions);
      console.log('‚úÖ Email sent successfully:', result.messageId);
      return result;
    } catch (error) {
      console.error('‚ùå Error sending email:', error);
      throw error;
    }
  }

  async verifyConnection() {
    try {
      if (!this.transporter) {
        console.log('‚ùå Email transporter not initialized');
        return false;
      }
      
      await this.transporter.verify();
      console.log('‚úÖ Email connection verified successfully');
      return true;
    } catch (error) {
      console.error('‚ùå Email connection verification failed:', error);
      return false;
    }
  }
}

module.exports = new EmailService(); 